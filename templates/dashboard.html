<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Motor Monitoring Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Moment.js -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-gear-fill me-2"></i>
                AI Motor Monitor v3.1
            </a>
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <div class="nav-item me-3">
                    <span class="badge" id="connectionBadge">Connecting...</span>
                </div>
                <div class="nav-item">
                    <small class="text-white" id="lastUpdate">Last Update: --</small>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-md-block bg-dark sidebar vh-100">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="#overview">
                                <i class="bi bi-speedometer2 me-2"></i>Overview
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#health">
                                <i class="bi bi-heart-pulse me-2"></i>Health Analysis
                                <span class="badge bg-danger ms-2" id="healthAlertBadge" style="display: none;">!</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#sensors">
                                <i class="bi bi-thermometer me-2"></i>Sensors
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#ai-insights">
                                <i class="bi bi-robot me-2"></i>AI Insights
                                <span class="badge bg-warning ms-2" id="recBadge" style="display: none;">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#control">
                                <i class="bi bi-sliders me-2"></i>Control
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="#alerts">
                                <i class="bi bi-exclamation-triangle me-2"></i>Alerts
                                <span class="badge bg-danger ms-2" id="alertBadge" style="display: none;">0</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10 ms-sm-auto px-md-4">
                <!-- System Status Cards -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="bi bi-heart-pulse fs-1"></i>
                                <h5 class="card-title mt-2">Motor Health</h5>
                                <div class="display-6" id="overallHealth">--</div>
                                <small id="healthStatus">Calculating...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="bi bi-cpu fs-1"></i>
                                <h5 class="card-title mt-2">ESP Status</h5>
                                <div id="espStatus">Disconnected</div>
                                <small id="espLastSeen">--</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="bi bi-hdd-network fs-1"></i>
                                <h5 class="card-title mt-2">PLC Status</h5>
                                <div id="plcStatus">Disconnected</div>
                                <small>FX5U (D100, D102)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body text-center">
                                <i class="bi bi-robot fs-1"></i>
                                <h5 class="card-title mt-2">AI Model</h5>
                                <div id="aiStatus">Initializing</div>
                                <small>Analytics Engine</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overview Section -->
                <section id="overview" class="mt-5">
                    <h3 class="mb-4">System Overview</h3>
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-graph-up me-2"></i>Real-Time Motor Parameters</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="overviewChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5><i class="bi bi-speedometer me-2"></i>Current Readings</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <div class="text-center p-3 border rounded">
                                                <h6 class="text-muted">Current (A)</h6>
                                                <h4 id="currentReading" class="text-primary">--</h4>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 border rounded">
                                                <h6 class="text-muted">Voltage (V)</h6>
                                                <h4 id="voltageReading" class="text-success">--</h4>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 border rounded">
                                                <h6 class="text-muted">RPM</h6>
                                                <h4 id="rpmReading" class="text-info">--</h4>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3 border rounded">
                                                <h6 class="text-muted">Temp (Â°C)</h6>
                                                <h4 id="tempReading" class="text-warning">--</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Health Analysis Section -->
                <section id="health" class="mt-5">
                    <h3 class="mb-4">Health Analysis</h3>
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-graph-down me-2"></i>Health Trends</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="healthChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5><i class="bi bi-clipboard-data me-2"></i>Health Summary</h5>
                                </div>
                                <div class="card-body" id="healthSummary">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2">Analyzing system health...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- AI Insights Section -->
                <section id="ai-insights" class="mt-5">
                    <h3 class="mb-4">AI-Powered Insights</h3>
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-lightbulb me-2"></i>Smart Recommendations</h5>
                        </div>
                        <div class="card-body" id="recommendationsList">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">AI is analyzing system data...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sensors Section -->
                <section id="sensors" class="mt-5">
                    <h3 class="mb-4">Sensor Monitoring</h3>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-thermometer me-2"></i>Temperature</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="temperatureChart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-droplet me-2"></i>Environmental</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h6>Ambient Temp</h6>
                                            <h4 id="ambientTemp">--Â°C</h4>
                                        </div>
                                        <div class="col-6">
                                            <h6>Humidity</h6>
                                            <h4 id="humidity">--%</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Control Section -->
                <section id="control" class="mt-5">
                    <h3 class="mb-4">Motor Control</h3>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-toggles me-2"></i>Relay Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-3">
                                        <span>Relay 1:</span>
                                        <span class="badge" id="relay1Status">OFF</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span>Relay 2:</span>
                                        <span class="badge" id="relay2Status">OFF</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Relay 3:</span>
                                        <span class="badge" id="relay3Status">OFF</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="bi bi-gear me-2"></i>Manual Control</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="motorControl('start')">
                                            <i class="bi bi-play-fill me-2"></i>Start Motor
                                        </button>
                                        <button class="btn btn-danger" onclick="motorControl('stop')">
                                            <i class="bi bi-stop-fill me-2"></i>Stop Motor
                                        </button>
                                        <button class="btn btn-warning" onclick="motorControl('reset')">
                                            <i class="bi bi-arrow-clockwise me-2"></i>Reset System
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Alerts Section -->
                <section id="alerts" class="mt-5 mb-5">
                    <h3 class="mb-4">System Alerts</h3>
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-bell me-2"></i>Active Alerts</h5>
                        </div>
                        <div class="card-body" id="alertsList">
                            <div class="text-center text-muted">
                                <i class="bi bi-check-circle fs-1 text-success"></i>
                                <p class="mt-2">No active alerts</p>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        // Global variables
        let socket;
        let charts = {};
        let sensorData = [];
        let maxDataPoints = 50;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeCharts();
            loadInitialData();
        });

        // Socket.IO initialization
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus(true);
                console.log('Connected to server');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                console.log('Disconnected from server');
            });

            socket.on('sensor_update', function(data) {
                updateDisplays(data);
                updateCharts(data);
            });

            socket.on('health_update', function(healthData) {
                updateHealthDisplays(healthData);
            });

            socket.on('recommendations_update', function(recommendations) {
                updateRecommendations(recommendations);
            });

            socket.on('status_update', function(status) {
                updateSystemStatus(status);
            });
        }

        // Initialize charts
        function initializeCharts() {
            // Overview Chart
            const overviewCtx = document.getElementById('overviewChart').getContext('2d');
            charts.overview = new Chart(overviewCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Current (A)',
                            data: [],
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)'
                        },
                        {
                            label: 'Voltage (V)',
                            data: [],
                            borderColor: '#198754',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)'
                        },
                        {
                            label: 'RPM',
                            data: [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Health Chart
            const healthCtx = document.getElementById('healthChart').getContext('2d');
            charts.health = new Chart(healthCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Overall Health',
                        data: [],
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 100
                        }
                    }
                }
            });

            // Temperature Chart
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            charts.temperature = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Motor Temperature (Â°C)',
                        data: [],
                        borderColor: '#fd7e14',
                        backgroundColor: 'rgba(253, 126, 20, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Update displays
        function updateDisplays(data) {
            if (!data) return;

            // Update current readings
            document.getElementById('currentReading').textContent = 
                data.esp_current ? `${data.esp_current.toFixed(2)}` : '--';
            document.getElementById('voltageReading').textContent = 
                (data.esp_voltage || data.plc_motor_voltage) ? `${(data.esp_voltage || data.plc_motor_voltage).toFixed(1)}` : '--';
            document.getElementById('rpmReading').textContent = 
                data.esp_rpm ? `${Math.round(data.esp_rpm)}` : '--';
            document.getElementById('tempReading').textContent = 
                data.plc_motor_temp ? `${data.plc_motor_temp.toFixed(1)}` : '--';

            // Update environmental readings
            document.getElementById('ambientTemp').textContent = 
                data.env_temp_c ? `${data.env_temp_c.toFixed(1)}Â°C` : '--Â°C';
            document.getElementById('humidity').textContent = 
                data.env_humidity ? `${data.env_humidity.toFixed(1)}%` : '--%';

            // Update relay status
            updateRelayStatus('relay1Status', data.relay1_status);
            updateRelayStatus('relay2Status', data.relay2_status);
            updateRelayStatus('relay3Status', data.relay3_status);

            // Update last update time
            document.getElementById('lastUpdate').textContent = 
                `Last Update: ${new Date().toLocaleTimeString()}`;
        }

        function updateRelayStatus(elementId, status) {
            const element = document.getElementById(elementId);
            if (status === 'ON') {
                element.textContent = 'ON';
                element.className = 'badge bg-success';
            } else {
                element.textContent = 'OFF';
                element.className = 'badge bg-secondary';
            }
        }

        function updateHealthDisplays(healthData) {
            if (!healthData) return;

            document.getElementById('overallHealth').textContent = 
                healthData.overall_health_score ? `${Math.round(healthData.overall_health_score)}%` : '--';
            document.getElementById('healthStatus').textContent = 
                healthData.status || 'No Data';

            // Show health alert if score is low
            const alertBadge = document.getElementById('healthAlertBadge');
            if (healthData.overall_health_score < 75) {
                alertBadge.style.display = 'inline-block';
            } else {
                alertBadge.style.display = 'none';
            }
        }

        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendationsList');
            const badge = document.getElementById('recBadge');

            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-success">
                        <i class="bi bi-check-circle-fill fs-1"></i>
                        <p class="mt-3">No recommendations</p>
                        <p class="text-muted">System operating optimally</p>
                    </div>
                `;
                badge.style.display = 'none';
                return;
            }

            let html = '';
            recommendations.forEach(rec => {
                const alertClass = rec.severity === 'CRITICAL' ? 'danger' : 
                                 rec.severity === 'HIGH' ? 'warning' : 'info';
                
                html += `
                    <div class="alert alert-${alertClass} mb-3">
                        <h6 class="alert-heading">
                            <i class="bi bi-lightbulb me-2"></i>${rec.title}
                            <span class="badge bg-${alertClass} ms-2">${rec.priority}</span>
                        </h6>
                        <p class="mb-2">${rec.description}</p>
                        <hr>
                        <p class="mb-0"><strong>Action:</strong> ${rec.action}</p>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // Update badge
            const highPriorityCount = recommendations.filter(r => 
                r.severity === 'CRITICAL' || r.priority === 'HIGH'
            ).length;
            
            if (highPriorityCount > 0) {
                badge.textContent = highPriorityCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateSystemStatus(status) {
            // Update ESP status
            const espCard = document.getElementById('espStatus').closest('.card');
            if (status.esp_connected) {
                document.getElementById('espStatus').textContent = 'Connected';
                espCard.className = espCard.className.replace(/bg-\w+/, 'bg-success');
            } else {
                document.getElementById('espStatus').textContent = 'Disconnected';
                espCard.className = espCard.className.replace(/bg-\w+/, 'bg-danger');
            }

            // Update PLC status
            const plcCard = document.getElementById('plcStatus').closest('.card');
            if (status.plc_connected) {
                document.getElementById('plcStatus').textContent = 'Connected';
                plcCard.className = plcCard.className.replace(/bg-\w+/, 'bg-info');
            } else {
                document.getElementById('plcStatus').textContent = 'Disconnected';
                plcCard.className = plcCard.className.replace(/bg-\w+/, 'bg-danger');
            }

            // Update AI status
            document.getElementById('aiStatus').textContent = status.ai_model_status;
        }

        function updateConnectionStatus(connected) {
            const badge = document.getElementById('connectionBadge');
            if (connected) {
                badge.textContent = 'Connected';
                badge.className = 'badge bg-success';
            } else {
                badge.textContent = 'Disconnected';
                badge.className = 'badge bg-danger';
            }
        }

        function updateCharts(data) {
            if (!data) return;

            const timestamp = new Date().toLocaleTimeString();
            
            // Update overview chart
            if (charts.overview) {
                const chart = charts.overview;
                chart.data.labels.push(timestamp);
                chart.data.datasets[0].data.push(data.esp_current || 0);
                chart.data.datasets[1].data.push(data.esp_voltage || data.plc_motor_voltage || 0);
                chart.data.datasets[2].data.push(data.esp_rpm || 0);

                // Keep only last 20 points
                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets.forEach(dataset => dataset.data.shift());
                }
                
                chart.update('none');
            }

            // Update temperature chart
            if (charts.temperature && data.plc_motor_temp) {
                const chart = charts.temperature;
                chart.data.labels.push(timestamp);
                chart.data.datasets[0].data.push(data.plc_motor_temp);

                if (chart.data.labels.length > 20) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                
                chart.update('none');
            }
        }

        function loadInitialData() {
            // Request initial data from server
            fetch('/api/current-data')
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        updateDisplays(result.data);
                        updateSystemStatus(result.system_status);
                        if (result.health_data) {
                            updateHealthDisplays(result.health_data);
                        }
                    }
                })
                .catch(error => console.error('Error loading initial data:', error));

            // Load recommendations
            fetch('/api/recommendations')
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        updateRecommendations(result.recommendations);
                    }
                })
                .catch(error => console.error('Error loading recommendations:', error));
        }

        function motorControl(command) {
            fetch('/api/motor-control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ command: command })
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    showToast(`Command "${command}" executed successfully`, 'success');
                } else {
                    showToast(`Error: ${result.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Motor control error:', error);
                showToast('Error sending command', 'error');
            });
        }

        function showToast(message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }
    </script>
</body>
</html>
